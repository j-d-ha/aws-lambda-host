version: '3'

tasks:
  clean:
    desc: Clean NuGet packages from Release folder
    silent: true
    cmds:
      - echo "ðŸ§¹ Cleaning"
      - '[ -d ./nupkg ] && rm -r ./nupkg || true'
      - dotnet clean --configuration Release
  
  restore:
    desc: Restore NuGet dependencies
    silent: true
    deps: [ clean ]
    cmds:
      - echo "ðŸ“¥ Restoring dependencies"
      - dotnet restore
      - echo "âœ… Dependencies restored"

  build:
    desc: Build solution in Release configuration
    silent: true
    deps: [ restore ]
    cmds:
      - echo "ðŸ”¨ Building Release"
      - dotnet build --configuration Release --no-restore
      - echo "âœ… Release build complete"

  build-debug:
    desc: Build solution in Debug configuration
    silent: true
    deps: [ restore ]
    cmds:
      - echo "ðŸ”¨ Building Debug"
      - dotnet build --configuration Debug --no-restore
      - echo "âœ… Debug build complete"

  pack:
    desc: Build the NuGet package
    silent: true
    deps: [ build ]
    cmds:
      - echo "ðŸ“¦ Packing Packages"
      - dotnet pack --configuration Release --no-build --output ./nupkg
      - echo "âœ… Packed"
  
  publish:
    desc: Publish the NuGet package to NuGet.org
    silent: true
    deps: [ pack ]
    cmds:
      - echo "ðŸš€ Publishing"
      - dotnet nuget push ./nupkg/*.nupkg --source https://api.nuget.org/v3/index.json --api-key $NUGET_API_KEY --skip-duplicate
      - echo "âœ¨ Published"

  aot-check:
    desc: Validates the AOT compatibility of the libraries
    silent: true
    cmds:
      - dotnet publish src/AotCompatibility.TestApp/AotCompatibility.TestApp.csproj /p:TreatWarningsAsErrors=true
  
  publish-local:
    desc: Publish to local NuGet source for use in other solutions
    silent: true
    deps: [ pack ]
    vars:
      LOCAL_NUGET_SOURCE: '{{.LOCAL_NUGET_SOURCE | default "~/LocalNuGetPackages"}}'
    cmds:
      - echo "ðŸ“¦ Publishing to local NuGet source"
      - mkdir -p {{.LOCAL_NUGET_SOURCE}}
      - cp -f ./nupkg/*.nupkg {{.LOCAL_NUGET_SOURCE}}/
      - echo "âœ… Published to {{.LOCAL_NUGET_SOURCE}}"
      - echo "ðŸ’¡ Add this source to your other solution with:"
      - echo "   dotnet nuget add source {{.LOCAL_NUGET_SOURCE}} --name local"